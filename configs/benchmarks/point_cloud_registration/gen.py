from typing import List
import os
import sys
sys.path.append("../../..")
import utils
os.chdir("../../..")


def add_heading(config: str) -> str:
    heading = ""
    heading += "# This file is automatically generated by `./configs/benchmarks/point_cloud_registration/gen.py`.\n"
    heading += "# Please do not attempt to modify manually.\n"
    config = heading + config
    return config


def main(dataset: str, model: str) -> None:
    template_name = "template_eval.py" if model in ['ICP', 'RANSAC_FPFH', 'TeaserPlusPlus'] else "template_train.py"
    with open(f"./configs/benchmarks/point_cloud_registration/{template_name}", mode='r') as f:
        config = f.read() + '\n'
    config = add_heading(config)
    # add runner
    if model in ['ICP', 'RANSAC_FPFH', 'TeaserPlusPlus']:
        config += f"from runners import BaseEvaluator\n"
        config += f"config['runner'] = BaseEvaluator\n"
        config += '\n'
    elif model == 'BUFFER':
        config += f"from runners.pcr_runners import BufferRunner\n"
        config += f"config['runner'] = BufferRunner\n"
        config += '\n'
    else:
        config += f"from runners import SupervisedSingleTaskTrainer\n"
        config += f"config['runner'] = SupervisedSingleTaskTrainer\n"
        config += '\n'
    if dataset.startswith('synth_pcr') or dataset.startswith('real_pcr'):
        overlap = float(dataset.split('_')[-1])
        dataset_name = '_'.join(dataset.split('_')[:-1])
    else:
        overlap = None
        dataset_name = dataset
    # add model config
    if model in ['ICP', 'RANSAC_FPFH', 'TeaserPlusPlus']:
        config += f"# data config\n"
        config += f"from configs.common.datasets.point_cloud_registration.val.classic_{dataset_name}_data_cfg import data_cfg as eval_data_cfg\n"
        if overlap is not None:
            config += f"eval_data_cfg['eval_dataset']['args']['overlap'] = {overlap}\n"
        config += f"config.update(eval_data_cfg)\n"
        config += '\n'
        if model == 'TeaserPlusPlus':
            config += f"# model config\n"
            config += f"from configs.common.models.point_cloud_registration.teaserplusplus_cfg import model_cfg\n"
            config += f"config['model'] = model_cfg\n"
            config += '\n'
        else:
            config += f"# model config\n"
            config += f"from models.point_cloud_registration.classic import {model}\n"
            config += f"config['model'] = {{'class': {model}, 'args': {{}}}}\n"
            config += '\n'
        if model == 'TeaserPlusPlus':
            config += f"config['eval_n_jobs'] = 1\n"
            config += '\n'
    elif model == 'GeoTransformer':
        config += f"# data config\n"
        config += f"from configs.common.datasets.point_cloud_registration.train.geotransformer_{dataset_name}_data_cfg import data_cfg as train_data_cfg\n"
        if overlap is not None:
            config += f"train_data_cfg['train_dataset']['args']['overlap'] = {overlap}\n"
        config += f"config.update(train_data_cfg)\n"
        config += f"from configs.common.datasets.point_cloud_registration.val.geotransformer_{dataset_name}_data_cfg import data_cfg as val_data_cfg\n"
        if overlap is not None:
            config += f"val_data_cfg['val_dataset']['args']['overlap'] = {overlap}\n"
        config += f"config.update(val_data_cfg)\n"
        config += '\n'
        config += f"# model config\n"
        config += f"from configs.common.models.point_cloud_registration.geotransformer_cfg import model_cfg\n"
        config += f"config['model'] = model_cfg\n"
        config += '\n'
        config += f"from configs.common.criteria.point_cloud_registration.geotransformer_criterion_cfg import criterion_cfg\n"
        config += f"config['criterion'] = criterion_cfg\n"
        config += '\n'
        config += f"from configs.common.metrics.point_cloud_registration.geotransformer_metric_cfg import metric_cfg\n"
        config += f"config['metric'] = metric_cfg\n"
        config += '\n'
    elif model == 'OverlapPredator':
        config += f"# data config\n"
        config += f"from configs.common.datasets.point_cloud_registration.train.overlappredator_{dataset_name}_data_cfg import data_cfg as train_data_cfg\n"
        if overlap is not None:
            config += f"train_data_cfg['train_dataset']['args']['overlap'] = {overlap}\n"
        config += f"config.update(train_data_cfg)\n"
        config += f"from configs.common.datasets.point_cloud_registration.val.overlappredator_{dataset_name}_data_cfg import data_cfg as val_data_cfg\n"
        if overlap is not None:
            config += f"val_data_cfg['val_dataset']['args']['overlap'] = {overlap}\n"
        config += f"config.update(val_data_cfg)\n"
        config += '\n'
        config += f"# model config\n"
        config += f"from configs.common.models.point_cloud_registration.overlappredator_cfg import model_cfg\n"
        config += f"config['model'] = model_cfg\n"
        config += '\n'
        config += f"from configs.common.criteria.point_cloud_registration.overlappredator_criterion_cfg import criterion_cfg\n"
        config += f"config['criterion'] = criterion_cfg\n"
        config += '\n'
        config += f"from configs.common.metrics.point_cloud_registration.overlappredator_metric_cfg import metric_cfg\n"
        config += f"config['metric'] = metric_cfg\n"
        config += '\n'
    elif model == 'BUFFER':
        config += f"# data config\n"
        config += f"from configs.common.datasets.point_cloud_registration.train.buffer_data_cfg import data_cfg as train_data_cfg\n"
        config += f"config.update(train_data_cfg)\n"
        config += f"from configs.common.datasets.point_cloud_registration.val.buffer_data_cfg import data_cfg as val_data_cfg\n"
        config += f"config.update(val_data_cfg)\n"
        config += '\n'
        config += f"# model config\n"
        config += f"from configs.common.models.point_cloud_registration.buffer_cfg import model_cfg\n"
        config += f"model_cfg['args']['config']['data']['dataset'] = 'KITTI'\n"
        config += f"config['model'] = model_cfg\n"
        config += '\n'
        base_config = config
        config += f"from configs.common.datasets.point_cloud_registration.train.buffer_data_cfg import multi_stage_criterion_cfg\n"
        config += f"from configs.common.datasets.point_cloud_registration.val.buffer_data_cfg import multi_stage_metric_cfg\n"
        config += f"multi_stage_cfg = []\n"
        config += f"import copy\n"
        config += '\n'
        config += f"ref_cfg = copy.deepcopy(config)\n"
        config += f"ref_cfg['stage'] = 'Ref'\n"
        config += f"ref_cfg['model']['args']['config']['stage'] = 'Ref'\n"
        config += f"ref_cfg['criterion'] = multi_stage_criterion_cfg[0]\n"
        config += f"ref_cfg['metric'] = multi_stage_metric_cfg[0]\n"
        config += f"multi_stage_cfg.append(ref_cfg)\n"
        config += '\n'
        config += base_config
        config += f"desc_cfg = copy.deepcopy(config)\n"
        config += f"desc_cfg['stage'] = 'Desc'\n"
        config += f"desc_cfg['model']['args']['config']['stage'] = 'Desc'\n"
        config += f"desc_cfg['criterion'] = multi_stage_criterion_cfg[1]\n"
        config += f"desc_cfg['metric'] = multi_stage_metric_cfg[1]\n"
        config += f"multi_stage_cfg.append(desc_cfg)\n"
        config += '\n'
        config += base_config
        config += f"keypt_cfg = copy.deepcopy(config)\n"
        config += f"keypt_cfg['stage'] = 'Keypt'\n"
        config += f"keypt_cfg['model']['args']['config']['stage'] = 'Keypt'\n"
        config += f"keypt_cfg['criterion'] = multi_stage_criterion_cfg[2]\n"
        config += f"keypt_cfg['metric'] = multi_stage_metric_cfg[2]\n"
        config += f"multi_stage_cfg.append(keypt_cfg)\n"
        config += '\n'
        config += base_config
        config += f"inlier_cfg = copy.deepcopy(config)\n"
        config += f"inlier_cfg['stage'] = 'Inlier'\n"
        config += f"inlier_cfg['model']['args']['config']['stage'] = 'Inlier'\n"
        config += f"inlier_cfg['criterion'] = multi_stage_criterion_cfg[3]\n"
        config += f"inlier_cfg['metric'] = multi_stage_metric_cfg[3]\n"
        config += f"multi_stage_cfg.append(inlier_cfg)\n"
        config += f"config = multi_stage_cfg\n"
        config += '\n'
    else:
        raise NotImplementedError
    # add seeds
    relpath = os.path.join("benchmarks", "point_cloud_registration", dataset)
    seeded_configs: List[str] = utils.automation.configs.generate_seeds(
        template_config=config, base_seed=relpath,
        base_work_dir=os.path.join("./logs", relpath, model),
    )
    # save to disk
    os.makedirs(os.path.join("./configs", relpath), exist_ok=True)
    for idx, seeded_config in enumerate(seeded_configs):
        with open(os.path.join("./configs", relpath, f"{model}_run_{idx}.py"), mode='w') as f:
            f.write(seeded_config)


if __name__ == "__main__":
    import itertools
    for dataset, model in itertools.product(
        [
            'synth_pcr_1.0', 'synth_pcr_0.5', 'synth_pcr_0.4',
            'real_pcr_1.0', 'real_pcr_0.5', 'real_pcr_0.4',
            'kitti',
        ],
        [
            'ICP', 'RANSAC_FPFH', 'TeaserPlusPlus',
            'GeoTransformer', 'OverlapPredator', 'BUFFER',
        ],
    ):
        main(dataset, model)
